#!/bin/bash

# Exit immediately if a command fails
set -e

echo "Scaling messaging-app-deployment to 3 replicas..."
kubectl scale deployment messaging-app-deployment --replicas=3

echo "Waiting for pods to be ready..."
kubectl wait --for=condition=Ready pod -l app=messaging-app --timeout=120s

echo "Current pods:"
kubectl get pods -l app=messaging-app

echo "Port-forwarding service to localhost:8000 for load testing..."
kubectl port-forward svc/messaging-app-service 8000:8000 &
PORT_FORWARD_PID=$!
sleep 5  # Give it time to establish connection

echo "Running load test with wrk (10s, 12 threads, 400 connections)..."
wrk -t12 -c400 -d10s http://127.0.0.1:8000/ || echo "wrk test failed. Is wrk installed?"

echo "Stopping port-forward..."
kill $PORT_FORWARD_PID

echo "Checking resource usage..."
kubectl top pods || echo "kubectl top failed. Is metrics-server installed?"

echo "Done."
